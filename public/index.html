<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BackMessage</title>
    <script src="socket.io.js"></script>
    <script>
      socket = io();

      socket.on("connect", function () {
        console.log("connected");
        setTimeout(s, 100);
      });

      socket.on("Dream", function (a) {
        a = a.split("|");
        if (a.length > 1) {
          var msg = a[0] + ": " + a[1];

          Bildirim(
            "BackMessage",
            msg,
            "https://img1.pngindir.com/20180704/vzj/kisspng-four-leaf-clover-royalty-free-5b3cb1a93ece21.5556515615307042972573.jpg"
          );

          d("msgs").innerHTML = msg + "\n" + d("msgs").innerHTML;

          ls("msgs", d("msgs").innerHTML);
        }
      });

      function d(a) {
        return document.getElementById(a);
      }

      function s() {
        socket.emit("SetName", d("me").value);
        ls("me", d("me").value);
      }
      function m() {
        if (event.keyCode == 13 && d("msg").value) {
          Dream(d("to").value + "|" + d("msg").value);
          d("msgs").innerHTML =
            d("me").value + ": " + d("msg").value + "\n" + d("msgs").innerHTML;
          d("msg").value = "";
          ls("msgs", d("msgs").innerHTML);
        }
      }

      function Dream(data) {
        if (typeof data === "object") {
          data = JSON.stringify(data);
        }
        socket.emit("Dream", data);
      }

      function Debounce(func, wait, immediate) {
        var timeout;
        return function () {
          var context = this,
            args = arguments;
          var later = function () {
            timeout = null;
            if (!immediate) func.apply(context, args);
          };
          var callNow = immediate && !timeout;
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
          if (callNow) func.apply(context, args);
        };
      }

      function Bildirim(title, text, img) {
        Notification.requestPermission().then(function (result) {
          /*console.log(result);*/
        });
        if (document.hidden) {
          new Notification(title, { body: text, icon: img });
        }
      }

      function ls(key, obj) {
        key = window.top.location.href + "_" + key;
        if (obj) {
          localStorage.setItem(key, JSON.stringify(obj));
        }
        if (localStorage.getItem(key) != null) {
          return JSON.parse(localStorage.getItem(key));
        } else {
          return [];
        }
      }

      var clearMsgs = function () {
        ls("msgs", []);
        d("msgs").innerHTML = "";
      };

      window.addEventListener("load", function () {
        Notification.requestPermission().then(function (result) {
          /*console.log(result);*/
        });

        d("me").value = ls("me");
        s();

        d("msgs").innerHTML = ls("msgs");

        d("me").addEventListener(
          "keyup",
          Debounce(function () {
            s();
          }, 500)
        );
      });
    </script>
    <style>
      input[type="text"],
      button {
        margin: 3px;
        padding: 3px;
      }
    </style>
  </head>
  <body>
    <input
      type="text"
      id="me"
      placeholder="kullanıcı adınız"
      onkeyup="this.value = this.value.toLowerCase();"
      style="text-transform: lowercase"
    />
    <input
      type="text"
      id="to"
      placeholder="kime"
      onkeyup="this.value = this.value.toLowerCase();"
      style="text-transform: lowercase"
    />
    <input type="text" id="msg" placeholder="mesaj yazın" onkeyup="m()" />
    <button type="button" onclick="clearMsgs()">mesajları temizle</button>
    <hr />
    <pre id="msgs"></pre>
  </body>
</html>
