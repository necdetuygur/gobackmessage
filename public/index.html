<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BackMessage</title>
    <script src="socket.io.js"></script>
    <script>
      socket = io();

      socket.on("connect", () => {
        console.log("connected");
        setTimeout(s, 100);
      });

      socket.on("Dream", (a) => {
        a = a.split("|");
        if (a.length > 1) {
          var msg = a[0] + ": " + a[1];
          
          Bildirim(
            "BackMessage",
            msg,
            "https://img1.pngindir.com/20180704/vzj/kisspng-four-leaf-clover-royalty-free-5b3cb1a93ece21.5556515615307042972573.jpg"
          );

          d("msgs").innerHTML = msg + "\n" + d("msgs").innerHTML;
        }
      });

      var d = (a) => document.getElementById(a);

      var s = () => SetName(d("me").value);

      var m = () => {
        if (event.keyCode == 13) {
          Dream(d("to").value + "|" + d("msg").value);
          d("msgs").innerHTML =
            d("me").value + ": " + d("msg").value + "\n" + d("msgs").innerHTML;
          d("msg").value = "";
        }
      };

      var Dream = (data) => {
        if (typeof data === "object") {
          data = JSON.stringify(data);
        }
        socket.emit("Dream", data);
      };

      var SetName = (name) => socket.emit("SetName", name);

      function Debounce(func, wait, immediate) {
        var timeout;
        return function () {
          var context = this,
            args = arguments;
          var later = function () {
            timeout = null;
            if (!immediate) func.apply(context, args);
          };
          var callNow = immediate && !timeout;
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
          if (callNow) func.apply(context, args);
        };
      }

      function Bildirim(title, text, img) {
        Notification.requestPermission().then(function (result) {
          /*console.log(result);*/
        });
        if (document.hidden) {
          new Notification(title, { body: text, icon: img });
        }
      }

      window.addEventListener("load", () => {
        Notification.requestPermission().then(function (result) {
          /*console.log(result);*/
        });

        d("me").addEventListener(
          "keyup",
          Debounce(() => {
            s();
          }, 500)
        );
      });
    </script>
    <style>
      input[type="text"] {
        margin: 3px;
        padding: 3px;
      }
    </style>
  </head>
  <body>
    <input
      type="text"
      id="me"
      placeholder="kullanıcı adınız"
      onkeyup="this.value = this.value.toLowerCase();"
      style="text-transform: lowercase"
    />
    <input
      type="text"
      id="to"
      placeholder="kime"
      onkeyup="this.value = this.value.toLowerCase();"
      style="text-transform: lowercase"
    />
    <input type="text" id="msg" placeholder="mesaj yazın" onkeyup="m()" />
    <hr />
    <pre id="msgs"></pre>
  </body>
</html>
